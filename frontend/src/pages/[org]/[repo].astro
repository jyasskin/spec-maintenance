---
import Duration from "@components/Duration.astro";
import GhLabel from "@components/GhLabel.astro";
import Issue from "@components/Issue.astro";
import Layout from "@layouts/Layout.astro";
import { englishUtcFormatter } from "@lib/formatTime.js";
import { IssueSummary } from "@lib/repo-summaries";
import {
agendaLengthSLO,
agendaSLO,
cmpByAgendaUsed,
cmpByTimeUsed,
groupBySlo,
soonSLO,
triageSLO,
urgentSLO,
} from "@lib/slo";
import * as ghLabels from "@lib/triage-labels";
import type {
GetStaticPaths,
InferGetStaticParamsType,
InferGetStaticPropsType,
} from "astro";
import { getCollection } from "astro:content";

export const getStaticPaths = (async () => {
    const repos = await getCollection("github");
    return repos.map((repo) => ({
        params: { org: repo.data.org, repo: repo.data.repo },
        props: { details: repo.data },
    }));
}) satisfies GetStaticPaths;

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { org, repo } = Astro.params as Params;
const { details } = Astro.props as Props;

const {
    untriaged,
    triageViolations,
    agenda,
    agendaViolations,
    soon,
    soonViolations,
    urgent,
    urgentViolations,
} = groupBySlo(IssueSummary.array().parse(details.issues));
urgent.push(...urgentViolations);
urgent.sort(cmpByTimeUsed);
soon.push(...soonViolations);
soon.sort(cmpByTimeUsed);
agenda.push(...agendaViolations);
agenda.sort(cmpByAgendaUsed);
untriaged.push(...triageViolations);
untriaged.sort(cmpByTimeUsed);
---

<script>
    import "@components/local-time.js";
</script>

<Layout title={`${org}/${repo} Issues`}>
    <h1>
        <a href=`https://github.com/${org}/${repo}/issues`
            >{org}/{repo} Issues</a
        >
    </h1>

    <p>
        Last updated <local-time datetime={details.cachedAt}
            >{
                englishUtcFormatter.format(new Date(details.cachedAt))
            }</local-time
        >.
    </p>

    {
        details.labelsPresent ? null : (
            <p>
                This repository doesn't have the
                <GhLabel {...ghLabels.eventually} /> label that's used to mark
                an issue as triaged without giving it an SLO. Until that's
                added, this summary uses heuristics to guess if each issue has
                been triaged.
            </p>
        )
    }

    <ul>
        {
            untriaged.length > 0 ? (
                <li>
                    <a href="#untriaged">
                        {triageViolations.length
                            ? `${triageViolations.length} out-of-SLO untriaged issues`
                            : `${untriaged.length} untriaged issues`}
                    </a>
                </li>
            ) : null
        }
        {
            urgent.length > 0 ? (
                <li>
                    <a href="#urgent">
                        {urgentViolations.length
                            ? `${urgentViolations.length} out-of-SLO urgent issues`
                            : `${urgent.length} urgent issues`}
                    </a>
                </li>
            ) : null
        }
        {
            agenda.length > 0 ? (
                <li>
                    <a href="#agenda">
                        {agenda.length > agendaLengthSLO &&
                        agendaViolations.length
                            ? `${agenda.length} issues on the agenda, ${agendaViolations.length} of which have been waiting too long; consider scheduling more meetings`
                            : agendaViolations.length
                              ? `${agendaViolations.length} issues on the agenda that have been waiting too long`
                              : `${agenda.length} issues on the agenda${agenda.length > agendaLengthSLO ? "; consider scheduling more meetings" : ""}`}
                    </a>
                </li>
            ) : null
        }
        {
            soon.length > 0 ? (
                <li>
                    <a href="#soon">
                        {soonViolations.length
                            ? `${soonViolations.length} out-of-SLO soon-priority issues`
                            : `${soon.length} soon-priority issues`}
                    </a>
                </li>
            ) : null
        }
    </ul>

    {
        untriaged.length > 0 ? (
            <>
                <h2 id="untriaged">Untriaged</h2>
                <p>
                    Try to
                    {/* prettier-ignore */}
                    <a href={`${import.meta.env.BASE_URL}about#need-triage`}>triage</a>
                    issues within <Duration d={triageSLO} />.
                </p>
                <ul>
                    {untriaged.map((issue) => (
                        <li>
                            <Issue {issue} />
                        </li>
                    ))}
                </ul>
            </>
        ) : null
    }

    {
        urgent.length > 0 ? (
            <>
                <h2 id="urgent">Urgent</h2>
                <p>
                    Try to resolve
                    {/* prettier-ignore */}
                    <a href={`${import.meta.env.BASE_URL}about#urgent`}>urgent
                        issues</a>
                    within <Duration d={urgentSLO} />.
                </p>
                <ul>
                    {urgent.map((issue) => (
                        <li>
                            <Issue {issue} />
                        </li>
                    ))}
                </ul>
            </>
        ) : null
    }

    {
        agenda.length > 0 ? (
            <>
                <h2 id="agenda">Agenda</h2>
                <p>
                    Try to maintain fewer than {agendaLengthSLO} agenda items
                    and discuss
                    {/* prettier-ignore */}
                    <a href={`${import.meta.env.BASE_URL}about#agenda`}>issues
                        on the agenda</a>
                    within <Duration d={agendaSLO} />.
                </p>
                <ul>
                    {agenda.map((issue) => (
                        <li>
                            <Issue {issue} agenda />
                        </li>
                    ))}
                </ul>
            </>
        ) : null
    }

    {
        soon.length > 0 ? (
            <>
                <h2 id="soon">Soon</h2>
                <p>
                    Try to resolve
                    {/* prettier-ignore */}
                    <a href={`${import.meta.env.BASE_URL}about#soon`}>soon-priority
                        issues</a>
                    within <Duration d={soonSLO} />.
                </p>
                <ul>
                    {soon.map((issue) => (
                        <li>
                            <Issue {issue} />
                        </li>
                    ))}
                </ul>
            </>
        ) : null
    }
</Layout>
